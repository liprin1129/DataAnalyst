---
title: "Load Data"
author: "Seongmuk Gang"
date: "18 December 2017"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: inline
---

## Set Wroking Directory
```{r}
#setwd('/mnt/SharedData/Development/Personal_Dev/DataAnalyst/HomeWork/P4_EDA/')
setwd("/Users/pure/Private_Local_Data/Study/Udacity/DataAnalyst/HomeWork/P4_EDA/")
```

## Import Libraries
```{r import library}
library(ggplot2)
library(dplyr)
```

## Features of data
I'm curious about why people take loans and what kinds of factors have effects on people to take a loan. There must be as well relationships between those factors, and it also must be hard to show clear correlations of such complex data. Therefore, I want to start Exploratory Data Analysis before I deeply dive into it.

First of all, I loaded csv data to R dataframe, and searched a length and number of variables. There are 113,937 debtors with 81 factors in the data.

```{r load csv}
pld <- read.csv('prosperLoanData.csv')
names(pld)
dim(pld)
```

It's necessray to know about types of variables, as well as whether they are continuous or discrete.
```{r}
str(pld)
```

# Univariate Analytics

## Loan Status

```{r univariate loan state}
ggplot(data=pld,aes(LoanStatus))+
  stat_count()+
  scale_y_sqrt()+
  labs(y="sqrt count")
```
Most of borrowers are currently paying their private loans. Following that, completed loan is the next most stat. Although many people pay back their loans completely, there are still more bollowers who are in bebt than who completed loans. 

```{r}
pld %>%
  group_by(LoanStatus) %>%
  summarise(n=n())
```

```{r}
pld %>%
  group_by(LoanStatus) %>%
  summarise(n=n()) %>%
  subset(LoanStatus != "Cancelled" & LoanStatus 
         != "Completed" & LoanStatus != "Current")
```

```{r sum laon state}
pld$num_debtors <- pld %>%
  group_by(LoanStatus) %>%
  summarise(n=n()) %>%
  subset(LoanStatus != "Cancelled" & LoanStatus != "Completed", 
         select = n) %>%
  sum()

pld$num_debtors[1]
```
There are 75,858 debtors in total. Sadly, many people are in trouble to pay back loans. 19282 people couldn't repay on time; 11,992 loans are charged-off and 5,018 people are in default on their loan.

```{r sum laon state2}
pld$delayed_payment <- pld %>%
  group_by(LoanStatus) %>%
  summarise(n=n()) %>%
  subset(LoanStatus != "Cancelled" & LoanStatus != "Completed" & 
           LoanStatus != "Current" & LoanStatus != "Chargedoff" &
           LoanStatus != "Defaulted" & LoanStatus != "FinalPaymentInProgress", 
         select = n) %>%
  sum()

pld$delayed_payment[1]
```
2067 bollowers had late payments. 

2,067 people are not in urgent situation of default or charged-off, but still of credit decline possibility, because of delayed repayment.

```{r sum Charged-off and Defaulted Debtors}
pld$dangerous_debtors <- pld %>%
  group_by(LoanStatus) %>%
  summarise(n=n()) %>%
  subset(LoanStatus == "Chargedoff" | LoanStatus == "Defaulted", 
         select = n) %>%
  sum()

pld$good_debtors <- pld %>%
  group_by(LoanStatus) %>%
  summarise(n=n()) %>%
  subset(LoanStatus == "Current", 
         select = n) %>%
  sum()

pld$non_deptors <- pld %>%
  group_by(LoanStatus) %>%
  summarise(n=n()) %>%
  subset(LoanStatus == "Completed" | LoanStatus == "Cancelled", select = n) %>%
  sum()

debt_or_no_df = data.frame(state = c("non_deptors", "num_debtors"),
                value = c(pld$non_deptors[1], pld$num_debtors[1]))

ggplot(aes(x = state, y = value/nrow(pld)*100), data = debt_or_no_df) + geom_bar(stat='identity') +
  labs(y = "borrower state %")
```

I plotted above information using percentage scale for easy comparison. The number of eople who have no any loan is much smaller than the number of people holding loans.

```{r}
debt_stat_df = data.frame(state = c("good borrowers", "delayed payment", "dangerous debtors"),
                value = c(pld$good_debtors[1], pld$delayed_payment[1], pld$dangerous_debtors[1]))

ggplot(aes(x = state, y = value/nrow(pld)*100), data = debt_stat_df) + geom_bar(stat='identity') +
  labs(y = "debt state %")
```

Among the people holding a loan, almost borrowers have no broblem in repaying their loan. Unfortunately, charged-off and defaulted case took about 18%.

## Credit Grade
```{r}
#pr$ListingCreationDate <- as.Date(pr$ListingCreationDate, format = "%Y-%m-%d %H:%M:%S") 
subset(pld, CreditGrade !="") %>%
ggplot(aes(x = CreditGrade)) +
  stat_count()
```

I ploted credit grade. There are a lot of no information which is populated after 2009, so I omitted it. Credit grade seems normally distributed, except lowest credit grade (HR) is slightly high. This plot shows something rediculous result, because loans were also admitted to HR and NC groups to which loans must not be allowed. 

I could not easily conclude at this stage a reason that this led default and charged-off situation, but it might be one of the factor for that. Moreover, It can be suspected that why credit grade information wasn't recorded since 2009, becuase allowing loans for low credit grade people had done a lot and Prosper wanted to hide that.

## Length of Loands
```{r}
pld$Term<-factor(pld$Term)

ggplot(data=pld,aes(Term)) + 
  geom_bar(color=I('black'),fill=I('#56B4E9'))
```
```{r}
table(pld$Term)/nrow(pld)*100
```

There are three types of loan legth; 12 months, 36 months, and 60 months. 36 months loan is the most popular, 77.0%, followed by long term loan (60 months), 21.5%. 12 months loan had just a small portion, 1.4%.

## Interest Rate
```{r}
ggplot(aes(x = BorrowerAPR), data = pld) +
  geom_histogram(binwidth = 0.01, color = 'black', fill = '#56B4E9')
```

```{r}
summary(pld$BorrowerAPR)
```

Borrower's APR seems uniformly distributed with bin width 0.01. Minimum rate was 0.007% and maximum rate was 0.5%, despite the peak on about 0.37 %.

## The origination amount of the loan.
```{r}
ggplot(aes(x = LoanOriginalAmount), data = pld) +
  geom_histogram(binwidth = 1000, color = 'black', fill = '#56B4E9')
```

Original amounts of loans looks like left-skewed with bin width 1000. However, there are some peaks in higher amounts. Probably they were the amount people mostly found. 

이것과 대출 발생 시간. (두개의 변수)

## The date the loan was originated.
```{r}
Sys.setenv(TZ="Asia/Tokyo")
Sys.getenv("TZ")
pld$LoanOriginationYear <- format(as.Date(pld$LoanOriginationDate, format = "%Y-%m-%d %H:%M:%S"), "%Y")

ggplot(aes(x=LoanOriginationYear), data=pld)+
  geom_bar()
```

왜 2013년이 가장 높은지 조사 하면 재밌겠다.

## The scheduled monthly loan payment.

```{r}
summary(pld$MonthlyLoanPayment)

ggplot(aes(x = MonthlyLoanPayment), data = pld) +
  geom_histogram(binwidth = 50)
```

Monthly loan payment totally seems left skewed. However, this is not convincing, because I assumed if montly lond payment depends on the origination amount of the loan. The origination amount of the loan also had a lef skewed distribution, but it had some peaks.

```{r}
pld$caculatedMonthlyLoanPayment <- as.numeric(pld$LoanOriginalAmount) / (as.numeric(pld$Term)*12)
pld$caculatedMonthlyLoanPayment <- pld$caculatedMonthlyLoanPayment + pld$caculatedMonthlyLoanPayment  * pld$BorrowerAPR
ggplot(aes(caculatedMonthlyLoanPayment), data = pld) + geom_histogram(binwidth = 40)
```

So, I invested more in detail by calculating montly loan payment using original loan amount and terms of when loans were bonded. Rough equation is like this; $ \frac{\text{Original Amount} }{\text{Term}} + \text{Original Amount} \times \text{APR} $. After plotting the result of the equation, the shape of histogram doesn't identical with MonthlyLoanPayment variable, but looks simlar. Therefore, even though there are some peaks on original loan amount, montly loan payment has left skewed distribution because it is related to APR.

## Monthly Imcome
```{r}
summary(pld$StatedMonthlyIncome)

ggplot(aes(StatedMonthlyIncome), data=pld) +
  geom_histogram(binwidth = 5000, color = 'black', fill = '#56B4E9')
  #geom_histogram(binwidth=500, color=I('black'), fill=I("#F79420") )
  #xlim(0,10000)
```

Monthly imcome seems to have tremendous outliers. From the histogram above with 5000\$ binwidth, most borrowers have sararies below than 250000\$. 

```{r}
ggplot(aes(x = "All Borrwers", y = StatedMonthlyIncome), data=pld) +
  geom_boxplot() +
  labs(x = "")
```

Furthermore, To identify outliers, I used boxplot. There is a huge gap between the largest outlier and within IQR. The largest outlier is about 2 million dolloars.

To see in detail, I cut the x axis up to 25000\$.

```{r}
ggplot(aes(x = "All Borrwers", y = StatedMonthlyIncome), data=pld) +
  geom_boxplot() + 
  coord_cartesian(ylim = c(0, 25000)) +
  labs(x = "")
```

Mean looks like below than 5000.

```{r}
ggplot(aes(StatedMonthlyIncome), data=pld) +
  geom_histogram(binwidth = 500, color = 'black', fill = '#56B4E9') +
  xlim(0,25000)
```

Obviously, it has left-skewed shape. 

If I cut the x axis up to 8000\$, I can see the first and third quantiles, which are about 7000 and 3000 respectively.

```{r}
ggplot(aes(x = "All Borrwers", y = StatedMonthlyIncome), data=pld) +
  geom_boxplot() + 
  coord_cartesian(ylim = c(0, 8000)) +
  labs(x = "")
```


```{r}
ggplot(aes(StatedMonthlyIncome), data=pld) +
  geom_histogram(binwidth = 500, color = 'black', fill = '#56B4E9') +
  xlim(0,8000)
```

When I cut it by 10000 \$which has most data with 500\$ bin, it seems nomarly distributed. 

## Home owner?

```{r}
ggplot(aes(x = IsBorrowerHomeowner), data = pld) +
  geom_bar()
```

A number of house owners and tanents almost same, but the number of houseowners is slightly higher than the number of tanents.

# Purpose of Loans
```{r}
ggplot(aes(x = ListingCategory..numeric.), data = pld) +
  stat_count()
```

Purposes of loans have 20 categories, and each category was recored as a mumeric value, such as

0 - Not Available
1 - Debt Consolidation
2 - Home Improvement
3 - Business
4 - Personal Loan
5 - Student Use
6 - Auto
7- Other
8 - Baby&Adoption
9 - Boat
10 - Cosmetic Procedure
11 - Engagement Ring
12 - Green Loans
13 - Household Expenses
14 - Large Purchases
15 - Medical/Dental
16 - Motorcycle
17 - RV
18 - Taxes
19 - Vacation
20 - Wedding Loans

The most common reason was debt consolidation.

## Univariate Analytics Summary
I shortly investigated some variables themselves which are about states of loans and of borrowers. Through this observation, the data showed meaningful for analytics but dangerous information for the individual borrowers. A large number of people were in charged-off or default situations. Also, borrowers didn't hold good credits when their loan started. Which means easy loan allowance drove into the bad situation for both company and borrowers.

# Bivariate Analytics

## Credit Grade and Loan Status
```{r}
#set.seed(1836)

#pld_subset <- subset(pld, select = c(LoanStatus, CreditGrade,Term, BorrowerAPR, LoanOriginalAmount, LoanOriginationYear, MonthlyLoanPayment, StatedMonthlyIncome, IsBorrowerHomeowner))

#names(pld_subset)

#ggpairs(pf_subset[sample.int(nrow(pf_subset), 100), ], axisLabels = 'internal')

#revalue(pld$LoanStatus, c("Cancelled" = "Cancelled", "Chargedoff" = "Chargedoff", "Completed" = "Completed", "Current" = "Current", "Defaulted" = "Defaulted", "Final" = "Final", "Past Due (1-15 days)" = "1-15 days", "Past Due (>120 days)" = ">120 days", "Past Due (16-30 days)" = "16-30 days", "Past Due (31-60 days)"= "31-60 days", "Past Due (61-90 days)" = "61-90 days", "Past Due (91-120 days)" ="91-120 days"))

#pld$LoanStatus <- factor(pld$LoanStatus, levels = c("Cancelled", "Chargedoff", "Completed", "Current", "Defaulted", "Final", "1-15 days", ">120 days", "16-30 days", "31-60 days", "61-90 days", "91-120 days"))

ggplot(aes(x = LoanStatus), data = subset(pld, CreditGrade !="")) +
  stat_count()+
  facet_wrap(~CreditGrade, ncol = 2)
```

I'm curious about how credit grades of borrowers have effects on their loan status. Because there are an level with no information in CreditGrade variable when I invested it in univariate session, I omitted it and plotted. Interestingly, people who have credit grade have only cancelled, charged-off, completed, and defaulted statuses. 

```{r}
ggplot(aes(x = LoanStatus), data = subset(pld, CreditGrade == "")) +
  stat_count()
```

And then I plotted loan status in terms of no credit grade. There are all loan statuses. It's unpredicted result, as I assumed credit grade is not national grade but only Prosper's internal grade in the first plot of LoanStatus in terms of CreditGrade variable. So, if it was the internal grade, there should not be cancelled, charged-off, completed, and defaulted statuses in no credit grade level of factor.

Therefore, I may conclude CreditGrade variable isn't reliable for further analytics.

## Loan Status and Length of Loans
```{r}
ggplot(aes(x = LoanStatus), data = pld) +
  stat_count() +
  facet_wrap(~Term, nrow = 1)
```

36 and 60 terms of loans seem to have a similar aspect. Current is the largest number, followed by Completed status.

```{r}
ggplot(aes(x = LoanStatus), data = subset(pld, Term == "12")) +
  stat_count() +
  facet_wrap(~Term, nrow = 1)
```

In 12 term loans, most people completed paying back loans, and charged-off and current status competed for the second place.

```{r}
ggplot(aes(x = LoanStatus), data = subset(pld, Term == "36")) +
  stat_count() +
  facet_wrap(~Term, nrow = 1)
```
```{r}
ggplot(aes(x = LoanStatus), data = subset(pld, Term == "60")) +
  stat_count() +
  facet_wrap(~Term, nrow = 1) +
  scale_x_discrete(name ="Loan Status", limits=c("Cancelled", "Chargedoff", "Completed", "Current", "Defaulted", "Final", "1-15 days", ">120 days", "16-30 days", "31-60 days", "61-90 days", "91-120 days"))
```
In both 60 and 36 terms, most people are paying back their loans. However, there are big gap between Current and Completed status in 60 terms loan, although 36 terms loan has not much difference as it between Current and Completed Status.

In summary, as terms of loans were shoter, the portion of Completed status were larger.

## Loan Status and Amount of Loan

```{r}
pld$OriginalLoanAmount.bucket <- cut(pld$LoanOriginalAmount, breaks = c(1000, 5000, 10000, 15000, 20000,
                                                                        25000, 30000, 35000))

table(pld$OriginalLoanAmount.bucket)

ggplot(aes(x = LoanStatus), data = pld) +
  stat_count() +
  facet_wrap(~OriginalLoanAmount.bucket, nrow = 2) + 
  theme(axis.text.x = element_blank(), axis.text.y = element_blank())
```

I grouped original loan amount into 8 groups by \$5000. Current status are dominant in almost groups. Only \$1000 ~ 5000 group has the largest height on Completed status. This result is the same as Loan Status and Length of Loans bar chart. Larger amount of original loan tended to have smaller repayment rate.

## Loan Original Year and APR

```{r}
t <- subset(pld, LoanOriginationYear == '2006')$BorrowerAPR %>%
  table()
t <- names(t)[which.max(t)]
apr_mean <- data.frame("APR.06" = t)
apr_mean$APR.06 <- t

t <- subset(pld, LoanOriginationYear == '2007')$BorrowerAPR %>%
  table()
t <- names(t)[which.max(t)]
apr_mean$APR.07 <- t

t <- subset(pld, LoanOriginationYear == '2008')$BorrowerAPR %>%
  table()
t <- names(t)[which.max(t)]
apr_mean$APR.08 <- t

t <- subset(pld, LoanOriginationYear == '2009')$BorrowerAPR %>%
  table()
t <- names(t)[which.max(t)]
apr_mean$APR.09 <- t

t <- subset(pld, LoanOriginationYear == '2010')$BorrowerAPR %>%
  table()
t <- names(t)[which.max(t)]
apr_mean$APR.10 <- t

t <- subset(pld, LoanOriginationYear == '2011')$BorrowerAPR %>%
  table()
t <- names(t)[which.max(t)]
apr_mean$APR.11 <- t

t <- subset(pld, LoanOriginationYear == '2012')$BorrowerAPR %>%
  table()
t <- names(t)[which.max(t)]
apr_mean$APR.12 <- t

t <- subset(pld, LoanOriginationYear == '2013')$BorrowerAPR %>%
  table()
t <- names(t)[which.max(t)]
apr_mean$APR.13 <- t

t <- subset(pld, LoanOriginationYear == '2014')$BorrowerAPR %>%
  table()
t <- names(t)[which.max(t)]
apr_mean$APR.14 <- t

apr_mean <- data.frame(rows = row.names(apr_mean), stack(apr_mean))
apr_mean$count <- as.numeric(table(subset(pld, LoanOriginationYear!="2005")$LoanOriginationYear))

ggplot(apr_mean) +
  geom_bar(aes(x = ind, y = count/50000), stat = "identity", color = 'black', fill = '#56B4E9') +
  geom_line(aes(x = ind, y = as.numeric(values), group = 1), color = 'red') +
  labs(y = 'APR')+
  scale_y_continuous(sec.axis = sec_axis(~.*50000, name = "Originated Year Count"))
```

There would be various reason why much more people made a loan on 2013 than other years. I got to be curious about that. Firstly, I assumed low APR might lead that trend, so inquiried APR rates which the most people used in each year. It looks like that after low APR year, people borrowed much money after that year. Especially, from 2010 to 2012, as APR increased, the number of people who used Prosper also goes high. However, it doesn't says 2013's biggest increase. 

```{r}
t <- subset(pld, LoanOriginationYear == '2006')$BorrowerAPR %>%
  table()
t <- min(as.numeric(names(t)))
apr_min <- data.frame("APR.06" = t)
#apr_mean$LOW.APR.06 <- t

t <- subset(pld, LoanOriginationYear == '2007')$BorrowerAPR %>%
  table()
t <- min(as.numeric(names(t)))
apr_min$LOW.APR.07 <- t

t <- subset(pld, LoanOriginationYear == '2008')$BorrowerAPR %>%
  table()
t <- min(as.numeric(names(t)))
apr_min$LOW.APR.08 <- t

t <- subset(pld, LoanOriginationYear == '2009')$BorrowerAPR %>%
  table()
t <- min(as.numeric(names(t)))
apr_min$LOW.APR.09 <- t

t <- subset(pld, LoanOriginationYear == '2009')$BorrowerAPR %>%
  table()
t <- min(as.numeric(names(t)))
apr_min$LOW.APR.09 <- t

t <- subset(pld, LoanOriginationYear == '2010')$BorrowerAPR %>%
  table()
t <- min(as.numeric(names(t)))
apr_min$LOW.APR.10 <- t

t <- subset(pld, LoanOriginationYear == '2011')$BorrowerAPR %>%
  table()
t <- min(as.numeric(names(t)))
apr_min$LOW.APR.11 <- t

t <- subset(pld, LoanOriginationYear == '2012')$BorrowerAPR %>%
  table()
t <- min(as.numeric(names(t)))
apr_min$LOW.APR.12 <- t

t <- subset(pld, LoanOriginationYear == '2013')$BorrowerAPR %>%
  table()
t <- min(as.numeric(names(t)))
apr_min$LOW.APR.13 <- t

t <- subset(pld, LoanOriginationYear == '2014')$BorrowerAPR %>%
  table()
t <- min(as.numeric(names(t)))
apr_min$LOW.APR.14 <- t

apr_min <- data.frame(rows = row.names(apr_min), stack(apr_min))
apr_min$count <- as.numeric(table(subset(pld, LoanOriginationYear!="2005")$LoanOriginationYear))

ggplot(apr_min) +
  geom_bar(aes(x = ind, y = count/500000), stat = "identity", color = 'black', fill = '#56B4E9') +
  geom_line(aes(x = ind, y = as.numeric(values), group = 1), color = 'red') +
  labs(y = 'APR')+
  scale_y_continuous(sec.axis = sec_axis(~.*500000, name = "Originated Year Count"))
```

Then, I searched the lowest APR rate of each year. Likewise, as APR rate of which many people used in that year, there seems not no proper reason for low APR rate would lead the increase of high demanding on Prosper loan company on 2013.

So I caculated correlation coefficients for both cases above. 
```{r}
cor(as.numeric(apr_mean$values), apr_mean$count)

cor(apr_min$values, apr_min$count)
```
Correlation coefficient for loan usage count and maximum APR rate of each year is 0.2613778, and minimum APR rate of each year and loan usage count is 0.3391221. According to my assumption that low APR rate caused more loans, this values should be minus. However, it wasn't.

As a consequence for Loan Original Year and APR, I want to opposite my original assumption. It is not that low APR cause high demantion demand on Prosper loan company. It is that because many people used Prosper, it increased lowest interest rate.

## Monthly Loan payment and Monthly Income

```{r}
cor(pld$StatedMonthlyIncome, pld$MonthlyLoanPayment)

pld$MonthlyPaymentAndImcomeRate <- pld$MonthlyLoanPayment/pld$StatedMonthlyIncome
Monthly <- subset(pld, MonthlyPaymentAndImcomeRate != "Inf" & MonthlyPaymentAndImcomeRate != "NaN")

most <- names(table(Monthly$MonthlyPaymentAndImcomeRate))[which.max(Monthly$MonthlyPaymentAndImcomeRate)]
percent95 <- quantile(pld$MonthlyPaymentAndImcomeRate, probs = .95, na.rm = TRUE)

ggplot(aes(x = as.numeric(MonthlyPaymentAndImcomeRate)), data = Monthly) +
  geom_histogram(binwidth = 0.005)+
  xlim(0, 1) +
  geom_vline(xintercept = percent95, 
             linetype = 'dashed', color = 'blue')
```

It seems that most people managed properly their loans' payment. They have an about 0.05 monthly income and payment rate. Although 86 percent of people paid back their loans by a tenth of their income, other people spent their monthly income for debts by the amount over a tenth. 

```{r}
Monthly_high <- subset(pld, 
                  MonthlyPaymentAndImcomeRate > quantile(MonthlyPaymentAndImcomeRate, probs = .95, na.rm = TRUE),
                  MonthlyPaymentAndImcomeRate != "Inf" & MonthlyPaymentAndImcomeRate != "NaN")

Monthly_low <- subset(pld, 
                  MonthlyPaymentAndImcomeRate < quantile(MonthlyPaymentAndImcomeRate, probs = .95, na.rm = TRUE),
                  MonthlyPaymentAndImcomeRate != "Inf" & MonthlyPaymentAndImcomeRate != "NaN")

table(Monthly_high$LoanStatus)

p1 <- ggplot(aes(x = LoanStatus), data = Monthly_high) +
  stat_count() +
  ggtitle("Monthly over 10%")

p2 <- ggplot(aes(x = LoanStatus), data = Monthly_low) +
  stat_count() +
  ggtitle("Monthly below 10%")

library(gridExtra)
grid.arrange(p1, p2, nrow = 2)
```

This plots of course seem quite in accord with intuition. People who had the payment-income rate over than 10% tended to be more in a situation of charged-off and defaulted than those who holded it 10% below. Interestingly, Completed status count was higher in the 'over 10% group'. I think that the heavy burdens for monthly repayments on them might stimulate to pay back their loans.

# Final Plots

Because there are 113937 samples in the dataset, it difficult to identify points when I plot points for continuous variables. So, for easy to see, I randomly sampled 1000 dataset.

```{r}
library(memisc)
pld$LoanStatusSimple <- pld$LoanStatus
levels(pld$LoanStatusSimple)[levels(pld$LoanStatusSimple) == "Past Due (>120 days)"] <- "Dangerous"
levels(pld$LoanStatusSimple)[levels(pld$LoanStatusSimple) == "Past Due (1-15 days)"] <- "Dangerous"
levels(pld$LoanStatusSimple)[levels(pld$LoanStatusSimple) == "Past Due (16-30 days)"] <- "Dangerous"
levels(pld$LoanStatusSimple)[levels(pld$LoanStatusSimple) == "Past Due (31-60 days)"] <- "Dangerous"
levels(pld$LoanStatusSimple)[levels(pld$LoanStatusSimple) == "Past Due (61-90 days)"] <- "Dangerous"
levels(pld$LoanStatusSimple)[levels(pld$LoanStatusSimple) == "Past Due (91-120 days)"] <- "Dangerous"

levels(pld$LoanStatusSimple)[levels(pld$LoanStatusSimple) == "Chargedoff"] <- "Dangerous"
levels(pld$LoanStatusSimple)[levels(pld$LoanStatusSimple) == "Defaulted"] <- "Dangerous"

levels(pld$LoanStatusSimple)[levels(pld$LoanStatusSimple) == "Completed"] <- "Safe"
levels(pld$LoanStatusSimple)[levels(pld$LoanStatusSimple) == "FinalPaymentInProgress"] <- "Safe"

set.seed(20022012)
pld_samp <- pld[sample(1:length(pld$MonthlyLoanPayment), 10000), ]
# MonthlyLoanPayment
# LoanOriginalAmount
# BorrowerAPR

ggplot(aes(x = LoanOriginalAmount, y = BorrowerRate, colour = LoanStatusSimple), data = subset(pld_samp, !is.na(LoanStatusSimple) & LoanStatusSimple != "Cancelled" & LoanStatusSimple != "Current" & LoanOriginalAmount <= 25000)) +
  geom_point(alpha = 0.1, size = 3) +
  geom_smooth(span = 0.9, se = FALSE) #method = 'lm'
  #scale_color_brewer(type = 'div') #+
  #xlim(0, 1000)
  #scale_x_log10()
```

Regardless of loan original amount, people were in dangerous situation (delayed payment, charged-off, and defaulted) when interest rates for their loans started over about 0.2. It seems there are aligned lines between in the two groups, which might distinguish .

```{r}
ggplot(aes(x = LoanOriginalAmount, y = BorrowerRate), data = subset(pld, LoanStatusSimple == "Dangerous")) +
  geom_point() +
  geom_smooth(method = 'lm', se = TRUE)
```

자신들의 소득 수준에 맞게 대출을 받았지만 이자율은 계산하지 않았기 때문일까? 이자율이 높고 소득이 작아서 위험한 상황이 발생하는 건 아닐까?

```{r}
ggplot(aes(x = LoanOriginalAmount, y = MonthlyPaymentAndImcomeRate), data = subset(pld, !is.na(LoanStatusSimple) & 
                                                                            LoanStatusSimple != "Cancelled" &
                                                                            LoanStatusSimple != "Current")) +
  geom_point(aes(colour = LoanStatusSimple), alpha = 0.5, size = 3)
  #scale_color_brewer(type = 'div') #+
  #ylim(0, 0.9)
  #scale_x_log10()
```

```{r}
ggplot(aes(x = LoanOriginalAmount, y = MonthlyLoanPayment), data = subset(pld, LoanStatus == "Chargedoff")) +
  geom_point(position = 'jitter')
```
--------------------------------------------------------------------------------------------------


```{r}
#require(dplyr)
ListingCategory <- data.frame(c('Not Available', 'Debt Consolidation', 'Home Improvement', 'Business', 'Personal Loan', 'Student Use', 'Auto', 'Other', 'Baby&Adoption', 'Boat', 'Cosmetic Procedure', 'Engagement Ring', 'Green Loans', 'Household Expenses', 'Large Purchases', 'Medical/Dental', 'Motorcycle', 'RV', 'Taxes', 'Vacation', 'Wedding Loans'))

t <- pld %>% group_by(LoanOriginationYear) %>% summarise(ListingCategory..numeric. = max(ListingCategory..numeric.))

t
```

To identify the reason about why in 2013 many people used Prosper, I observed the relation between loan origination year and loan's popular category in that year. However, I cannot find any prosper reason for it, as there is many changes between years for purposes of loans. From 2011 to 2014, category 20; wedding loan, was the most reason for borrowers. 

```{r}
t <- pld %>%
  group_by(LoanOriginationYear)

for (i in a$LoanOriginationYearMonthDate) {
  subset(a, LoanOriginationYearMonthDate == i)
  }

t <- pld %>%
  group_by(LoanOriginationYear)
  
t <- table(t$ListingCategory..numeric.)

names(t)[which.max(t)]

ggplot(aes(x = ListingCategory..numeric.), data = pld) +
  stat_count()
```



```{r}
pld$LoanOriginationYearMonthDate <- substr(pld$LoanOriginationDate,0,10)
group_by(pld, LoanOriginationYearMonthDate)

for (i in a$LoanOriginationYearMonthDate) {
  subset(a, LoanOriginationYearMonthDate == i)
  }

apr_06 <- table(subset(pld, LoanOriginationYear == '2006')$BorrowerAPR) %>%
  names() %>%
  as.numeric()
apr_count_06 <- table(subset(pld, LoanOriginationYear == '2006')$BorrowerAPR) %>%
  as.vector()
apr_mean <- data.frame("APR.16" = mean(apr_06*apr_count_06))

apr_07 <- table(subset(pld, LoanOriginationYear == '2007')$BorrowerAPR) %>%
  names() %>%
  as.numeric()
apr_count_07 <- table(subset(pld, LoanOriginationYear == '2007')$BorrowerAPR) %>%
  as.vector()
apr_mean$APR.07 <- mean(apr_07*apr_count_07)

apr_08 <- table(subset(pld, LoanOriginationYear == '2008')$BorrowerAPR) %>%
  names() %>%
  as.numeric()
apr_count_08 <- table(subset(pld, LoanOriginationYear == '2008')$BorrowerAPR) %>%
  as.vector()
apr_mean$APR.08 <- mean(apr_08*apr_count_08)

apr_09 <- table(subset(pld, LoanOriginationYear == '2009')$BorrowerAPR) %>%
  names() %>%
  as.numeric()
apr_count_09 <- table(subset(pld, LoanOriginationYear == '2009')$BorrowerAPR) %>%
  as.vector()
apr_mean$APR.09 <- mean(apr_09*apr_count_09)

apr_10 <- table(subset(pld, LoanOriginationYear == '2010')$BorrowerAPR) %>%
  names() %>%
  as.numeric()
apr_count_10 <- table(subset(pld, LoanOriginationYear == '2010')$BorrowerAPR) %>%
  as.vector()
apr_mean$APR.10 <- mean(apr_10*apr_count_10)

apr_11 <- table(subset(pld, LoanOriginationYear == '2011')$BorrowerAPR) %>%
  names() %>%
  as.numeric()
apr_count_11 <- table(subset(pld, LoanOriginationYear == '2011')$BorrowerAPR) %>%
  as.vector()
apr_mean$APR.11 <- mean(apr_11*apr_count_11)

apr_12 <- table(subset(pld, LoanOriginationYear == '2012')$BorrowerAPR) %>%
  names() %>%
  as.numeric()
apr_count_12 <- table(subset(pld, LoanOriginationYear == '2012')$BorrowerAPR) %>%
  as.vector()
apr_mean$APR.12 <- mean(apr_12*apr_count_12)

apr_13 <- table(subset(pld, LoanOriginationYear == '2013')$BorrowerAPR) %>%
  names() %>%
  as.numeric()
apr_count_13 <- table(subset(pld, LoanOriginationYear == '2013')$BorrowerAPR) %>%
  as.vector()
apr_mean$APR.13 <- mean(apr_13*apr_count_13)

apr_14 <- table(subset(pld, LoanOriginationYear == '2014')$BorrowerAPR) %>%
  names() %>%
  as.numeric()
apr_count_14 <- table(subset(pld, LoanOriginationYear == '2014')$BorrowerAPR) %>%
  as.vector()
apr_mean$APR.14 <- mean(apr_14*apr_count_14)

apr_mean <- data.frame(rows = row.names(apr_mean), stack(apr_mean))

p <- ggplot(aes(x = BorrowerAPR), data = pld) +
  geom_freqpoly(aes(colour = LoanOriginationYear), binwidth = 0.01)
```

```{r}
#Let's create a variable that includes only month and year of the loan origination date
pld$LoanOriginationYearMonthDate <- substr(pld$LoanOriginationDate,0,10)

ggplot(pld,aes(yearmth_orig_date,fill=factor(Term))) + 
      geom_bar( colour="darkgreen")
```
levels(factor(seq(1, 31, by=1)))
```{r}
# Summarize the data by yearmth_orig_date and Term
# The metrics calculated by yearmth_orig_date and Term are
# mean borrower rate, mean loan origination amount and 
# mean monthly loan payment
avg_rate_amt2 <- pld %>%
  group_by(yearmth_orig_date,Term) %>%
  summarise(
    Rate_mean = mean(BorrowerRate, na.rm = TRUE),
    LoanAmount_mean = mean(LoanOriginalAmount, na.rm = TRUE),
    monthlypayment_mean = mean(MonthlyLoanPayment, na.rm = TRUE),
    count_loan = n()
  )

p1 <- ggplot(data=avg_rate_amt2,
            aes(x=yearmth_orig_date,y=count_loan,fill=Term)) + 
            geom_bar(stat = "identity") 

p2 <- ggplot(data=avg_rate_amt2,
            aes(yearmth_orig_date,LoanAmount_mean)) +
            geom_line(aes(colour=Term))

grid.arrange(p1, p2, ncol=2)
```

```{r}
#Let's select only the variables of interest.
selected_vars <- c("BorrowerRate","DebtToIncomeRatio",
                   "ProsperScore","CreditScoreRangeLower",
                   "DelinquenciesLast7Years","LoanOriginalAmount",
                   "MonthlyLoanPayment")

pr_column_select <- pr[,selected_vars]
pr_column_select<-na.omit(pr_column_select)

ggpairs(pr_column_select)
```

```{r}
# Fake data
y<- sample(10, 100, rep=T)
x <- rnorm(100)

# plots
par(mfrow=c(2,3)) # open an object
plot(x,y) # First plot
title("Default plot")

plot(x,y, axes = FALSE) # Second plot
title("Without any axis")

plot(x,y, axes = FALSE) # Third plot
axis(1)
title("X-axis added, but as is")

plot(x,y, axes = FALSE) # Fourth plot
axis(2)
title("Y-axis added, but as is")

yticks <- seq(5, 12, 1)
plot(x,y, axes = FALSE) # Fifth plot
axis(2, at = yticks, labels = yticks, col.axis="red", las=2)
title("Manipulated Y-axis")

xticks <- seq(0, 3, .5)
plot(x,y, axes = FALSE) # Sixth plot
axis(2, at = yticks, labels = yticks, col.axis="red", las=2)
axis(1, at = xticks, labels = xticks, col.axis="blue", las=2, tck=-.01)
title("Manipulated Y and X axes")
```

